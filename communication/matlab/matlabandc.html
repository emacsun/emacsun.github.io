<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title>Matlab与C混合编程之一：基本原理</title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Eastern(ZCL)" />
<meta  name="description" content="本文描述LTE-FDD和TDD的频带资源"
 />
<meta  name="keywords" content="matlab communication simulation C" />
<link rel="stylesheet" type="text/css" href="../../css/worg.css"  />
<a id="home" href="../../index.html"><img src="../../img/assets/home.png" ></a>
<a id="pdf"  href="./matlabandc.pdf"><img src="../../img/assets/pdf.png"></a>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "left",
        displayIndent: "7em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "Neo-Euler"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "Neo-Euler"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Matlab与C混合编程之一：基本原理</h1>
<div id="table-of-contents">
<h2>目录</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline1">1. 引言</a></li>
<li><a href="#orgheadline7">2. 使用mex编译c函数</a>
<ul>
<li><a href="#orgheadline2">2.1. 一个例子</a></li>
<li><a href="#orgheadline3">2.2. 编写源代码</a></li>
<li><a href="#orgheadline4">2.3. 创建桥梁变量</a></li>
<li><a href="#orgheadline5">2.4. 创建 <code>MEX</code> 文件</a></li>
<li><a href="#orgheadline6">2.5. 调用 <code>MEX</code> 文件</a></li>
</ul>
</li>
<li><a href="#orgheadline10">3. Mex文件的数据流</a>
<ul>
<li><a href="#orgheadline8">3.1. 输入和输出</a></li>
<li><a href="#orgheadline9">3.2. <code>mexFunction</code> 的数据流动</a></li>
</ul>
</li>
<li><a href="#orgheadline11">4. 尾声</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1"><span class="section-number-2">1</span> 引言</h2>
<div class="outline-text-2" id="text-1">
<p>

</p>

<p>
matlab是Mathworks公司推出的一款强大的仿真软件。由于其简单易用，建模迅捷，函数库保罗万象，因此得到广泛使用，尤其在通信与信息系统仿真中更是大显身手。matlab使用的语言也叫matlab，是一门脚本语言。脚本语言的特性决定了其编写方便快速，但是运行速度却不及C/C++等编译型语言。为综合脚本语言和编译型语言的优点，matlab支持与C的混合编程。本文是我的matlab与C混合编程系列博文的第一篇，主要介绍matlab如何调用C语言编写的函数。在之后的一些博文中介绍matlab提供的调用C函数需要使用的API。
</p>

<p>
这一系列博文的诸多例子来自matlab自带的帮助文档。在学习的过程中，结合自己的心得，成此博文。读者完全可以通过matlab的帮助文档来学习如何使用这些API。但matlab的帮助文档略显生硬，有些冷冰冰。在涉及重点以及可能会碰到的bug时，不会像我在这里大声疾呼:"这是个坑，小心"。因此我认为这些博文还是有其存在的价值。当然，我也力图博文朗朗上口，深入浅出，读起来引人入胜。
</p>
</div>
</div>

<div id="outline-container-orgheadline7" class="outline-2">
<h2 id="orgheadline7"><span class="section-number-2">2</span> 使用mex编译c函数</h2>
<div class="outline-text-2" id="text-2">
<p>

</p>

<p>
我们知道在C语言编程过程中，每个程序都包含 <code>main</code> 函数。在 <code>main</code>  函数中，我们可以调用我们编写的其他函数。如果要在matlab脚本中调用c函数，需要一个特殊的函数将用户自己定义的函数封装起来。这个函数叫做 <code>mexFunction</code> ， <code>mexFunction</code> 就像一座桥梁一样链接了matlab脚本语言和C这种编译型语言，matlab调用 <code>mexFunction</code> ， <code>mexFunction</code> 调用用户自定义的函数。接下来用一个简单的例子演示如何使用 <code>mexFunction</code> 将我们定义的函数封装起来以及如何在matlab中调用这个C函数。
</p>
</div>
<div id="outline-container-orgheadline2" class="outline-3">
<h3 id="orgheadline2"><span class="section-number-3">2.1</span> 一个例子</h3>
<div class="outline-text-3" id="text-2-1">
<p>

</p>

<p>
假设我们要实现：一个标量 \(x\)  乘以一个适量 \(\mathbf{Y}\)，结果保存在矢量 \(\mathbf{Z}\)中。整个过程如式\ref{eq:scalartimevector}所示。
</p>
\begin{equation}
\label{eq:scalartimevector}
\mathbf{Z} = x\mathbf{Y}
\end{equation}

<p>
我们用C语言实现这个功能，函数命名为 <code>arrayProduct</code> ，代码如下(这个例子就来自matlab的帮助文档)：
</p>
<div class="org-src-container">

<pre class="src src-C"><span class="linenr">1: </span><span style="color: #b58900;">void</span> <span style="color: #268bd2;">arrayProduct</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">double</span> <span style="color: #268bd2;">x</span>, <span style="color: #b58900;">double</span> *<span style="color: #268bd2;">Y</span>, <span style="color: #b58900;">double</span> *<span style="color: #268bd2;">Z</span>, <span style="color: #b58900;">int</span> <span style="color: #268bd2;">n</span><span style="color: #2aa198;">)</span>
<span class="linenr">2: </span><span style="color: #2aa198;">{</span>
<span class="linenr">3: </span>  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span>;
<span class="linenr">4: </span>
<span class="linenr">5: </span>  <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>i=<span style="color: #6c71c4;">0</span>; i&lt;n; i++<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
<span class="linenr">6: </span>    Z<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span> = x * Y<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>;
<span class="linenr">7: </span>  <span style="color: #b58900;">}</span>
<span class="linenr">8: </span><span style="color: #2aa198;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><span class="section-number-3">2.2</span> 编写源代码</h3>
<div class="outline-text-3" id="text-2-2">
<p>

</p>

<p>
打开matlab编辑器，创建一个新文件，为其添加文件头
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #586e75;">/*</span>
<span style="color: #586e75;"> *arrayProduct.c - example in MATLAB External Interfaces</span>
<span style="color: #586e75;"> *</span>
<span style="color: #586e75;"> * Multiplies an input scalar (multiplier)</span>
<span style="color: #586e75;"> * times a 1xN matrix (inMatrix)</span>
<span style="color: #586e75;"> * and outputs a 1xN matrix (outMatrix)</span>
<span style="color: #586e75;"> *</span>
<span style="color: #586e75;"> * The calling syntax is:</span>
<span style="color: #586e75;"> *</span>
<span style="color: #586e75;"> *    outMatrix = arrayProduct(multiplier, inMatrix)</span>
<span style="color: #586e75;"> *</span>
<span style="color: #586e75;"> * This is a MEX-file for MATLAB.</span>
<span style="color: #586e75;">*/</span>
<span style="color: #268bd2;">#include</span> <span style="color: #2aa198;">"mex.h"</span>
</pre>
</div>
<p>
以上代码来自matlab的帮助文档，其为我们展示了如何编写一个清新脱俗的文件头。最后一行是调用 C/C++ 函数必须的头文件，其包含了matlab定义的一些API。先把这个文件保存起来，文件名为 <code>arrayProduct.c</code> ，在后面我们用 <code>mex</code> 命令编译的 <code>MEX</code> 文件会自动命名为 <code>arrayProduct</code> 。在matlab的脚本里调用 <code>arrayProduct</code> 就像调用matlab的内嵌函数一样。对于用户来讲 <code>mexFunction</code> 是透明的，不用关心的。 <code>mexFunction</code> 需要程序员写好，供用户使用，然后程序员深藏功与名，幕后螺丝钉。
</p>
</div>
</div>
<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4"><span class="section-number-3">2.3</span> 创建桥梁变量<a id="orgtarget1"></a></h3>
<div class="outline-text-3" id="text-2-3">
<p>

</p>

<p>
这一部分是最重要的，在我学习matlab和c混合编程过程中，这一步用的时间最多。前文曾提到：每一个C程序都有一个 <code>main</code> 函数，但是matlab里有 <code>mexFunction</code> 函数。刚才的 <code>arrayProduct.c</code> 文件里添加 <code>mexFunction</code> 函数如下所示:
</p>
<div class="org-src-container">

<pre class="src src-C"><span style="color: #586e75;">/* </span><span style="color: #586e75;">The gateway function </span><span style="color: #586e75;">*/</span>
<span style="color: #b58900;">void</span> <span style="color: #268bd2;">mexFunction</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">nlhs</span>, <span style="color: #b58900;">mxArray</span> *<span style="color: #268bd2;">plhs</span><span style="color: #b58900;">[]</span>,
     <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nrhs</span>, <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #b58900;">mxArray</span> *<span style="color: #268bd2;">prhs</span><span style="color: #b58900;">[]</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">{</span>
<span style="color: #586e75;">/* </span><span style="color: #586e75;">variable declarations here </span><span style="color: #586e75;">*/</span>

<span style="color: #586e75;">/* </span><span style="color: #586e75;">code here </span><span style="color: #586e75;">*/</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>

<p>
初看 <code>mexFunction</code> 函数会感觉一头雾水， <code>main</code> 函数才最多两个输入参数，这个就有四个，而且指针的类型都没有见过。莫慌，表<a href="#orgtable1">1</a>解释了 <code>mexFunction</code> 的参数，我在后文还会附上详细解释。
</p>
<table id="orgtable1" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">表 1:</span> <code>mexFunction</code> 函数的参数含义</caption>

<colgroup>
<col  class="org-center" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-center">参数名</th>
<th scope="col" class="org-left">含义</th>
<th scope="col" class="org-left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<th scope="row" class="org-center"><code>nlhs</code></th>
<td class="org-left">number of output（left-side） arguments， <code>plhs</code> 的大小</td>
<td class="org-left">number of left hand side</td>
</tr>

<tr>
<th scope="row" class="org-center"><code>plhs</code></th>
<td class="org-left">array of arguments, 输出参数的指针列表</td>
<td class="org-left">pointer of left hand side</td>
</tr>

<tr>
<th scope="row" class="org-center"><code>nrhs</code></th>
<td class="org-left">number of input（right-side） arguments， <code>prhs</code> 的大小</td>
<td class="org-left">number of right hand side</td>
</tr>

<tr>
<th scope="row" class="org-center"><code>prhs</code></th>
<td class="org-left">array of input arguments, 输入参数的指针列表</td>
<td class="org-left">pointer of right hand side</td>
</tr>
</tbody>
</table>

<p>
这里的左手边参数和右手边参数指的是matlab调用 <code>arrayProduct</code> 的过程中使用的实际参数，而 <code>mexFunction</code> 需要做的工作是把matlab调用的参数与用户定义的 <code>arrayProduct.c</code> 里的 <code>arrayProduct</code> 对应起来。假设现在我们已经把C函数 <code>arrayProduct</code> 变成了matlab可以调用的函数。其调用过程为：
</p>
<div class="org-src-container">

<pre class="src src-matlab">x = 2;
Y = [4, 3, 8];
Z = arrayProduct(x,Y)
</pre>
</div>
<p>
那么，其 <code>nlhs=1</code> ， <code>nrhs=2</code> ， <code>plhs</code> 。在 <code>mexFunction</code> 中， <code>plhs</code> 就是指向 <code>Z</code> 的指针， <code>prhs</code> 就是指向 <code>x,Y</code> 的指针数组，因为右手边有两个参数，所以 <code>prhs</code> 是一个指针数组， <code>prhs[0]</code> 指向 <code>x</code> ， <code>prhs[1]</code> 指向 <code>Y</code> 。
</p>

<p>
好了，刚才我们简单解释了一下桥梁函数 <code>mexFunction</code> 的输入和输出，现在实现桥梁变量，到现在为止你的 <code>arrayProduct.c</code> 中的内容应该是：
</p>
<div class="org-src-container">

<pre class="src src-c"><span class="linenr"> 1: </span><span style="color: #586e75;">/*</span>
<span class="linenr"> 2: </span><span style="color: #586e75;"> *arrayProduct.c - example in MATLAB External Interfaces</span>
<span class="linenr"> 3: </span><span style="color: #586e75;"> *</span>
<span class="linenr"> 4: </span><span style="color: #586e75;"> * Multiplies an input scalar (multiplier)</span>
<span class="linenr"> 5: </span><span style="color: #586e75;"> * times a 1xN matrix (inMatrix)</span>
<span class="linenr"> 6: </span><span style="color: #586e75;"> * and outputs a 1xN matrix (outMatrix)</span>
<span class="linenr"> 7: </span><span style="color: #586e75;"> *</span>
<span class="linenr"> 8: </span><span style="color: #586e75;"> * The calling syntax is:</span>
<span class="linenr"> 9: </span><span style="color: #586e75;"> *</span>
<span class="linenr">10: </span><span style="color: #586e75;"> *    outMatrix = arrayProduct(multiplier, inMatrix)</span>
<span class="linenr">11: </span><span style="color: #586e75;"> *</span>
<span class="linenr">12: </span><span style="color: #586e75;"> * This is a MEX-file for MATLAB.</span>
<span class="linenr">13: </span><span style="color: #586e75;">*/</span>
<span class="linenr">14: </span><span style="color: #268bd2;">#include</span> <span style="color: #2aa198;">"mex.h"</span>
<span class="linenr">15: </span><span style="color: #b58900;">void</span> <span style="color: #268bd2;">arrayProduct</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">double</span> <span style="color: #268bd2;">x</span>, <span style="color: #b58900;">double</span> *<span style="color: #268bd2;">Y</span>, <span style="color: #b58900;">double</span> *<span style="color: #268bd2;">Z</span>, <span style="color: #b58900;">int</span> <span style="color: #268bd2;">n</span><span style="color: #2aa198;">)</span>
<span class="linenr">16: </span><span style="color: #2aa198;">{</span>
<span class="linenr">17: </span>  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span>;
<span class="linenr">18: </span>
<span class="linenr">19: </span>  <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>i=<span style="color: #6c71c4;">0</span>; i&lt;n; i++<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
<span class="linenr">20: </span>    Z<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span> = x * Y<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>;
<span class="linenr">21: </span>  <span style="color: #b58900;">}</span>
<span class="linenr">22: </span><span style="color: #2aa198;">}</span>
<span class="linenr">23: </span><span style="color: #586e75;">/* </span><span style="color: #586e75;">The gateway function </span><span style="color: #586e75;">*/</span>
<span class="linenr">24: </span><span style="color: #b58900;">void</span> <span style="color: #268bd2;">mexFunction</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">nlhs</span>, <span style="color: #b58900;">mxArray</span> *<span style="color: #268bd2;">plhs</span><span style="color: #b58900;">[]</span>,
<span class="linenr">25: </span>     <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nrhs</span>, <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #b58900;">mxArray</span> *<span style="color: #268bd2;">prhs</span><span style="color: #b58900;">[]</span><span style="color: #2aa198;">)</span>
<span class="linenr">26: </span><span style="color: #2aa198;">{</span>
<span class="linenr">27: </span><span style="color: #586e75;">/* </span><span style="color: #586e75;">variable declarations here </span><span style="color: #586e75;">*/</span>
<span class="linenr">28: </span>
<span class="linenr">29: </span><span style="color: #586e75;">/* </span><span style="color: #586e75;">code here </span><span style="color: #586e75;">*/</span>
<span class="linenr">30: </span><span style="color: #2aa198;">}</span>
</pre>
</div>

<p>
我们要在 <code>mexFunction</code> 函数体里定义与 <code>x</code> <code>Y</code> <code>Z</code> 对应的桥梁变量，这些桥梁变量链接了matlab脚本和 <code>arrayProduct</code> 函数。
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #b58900;">void</span> <span style="color: #268bd2;">mexFunction</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">nlhs</span>, <span style="color: #b58900;">mxArray</span> *<span style="color: #268bd2;">plhs</span><span style="color: #b58900;">[]</span>,
     <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nrhs</span>, <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #b58900;">mxArray</span> *<span style="color: #268bd2;">prhs</span><span style="color: #b58900;">[]</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">{</span>
<span style="color: #586e75;">/* </span><span style="color: #586e75;">variable declarations here </span><span style="color: #586e75;">*/</span>
   <span style="color: #b58900;">double</span> <span style="color: #268bd2;">multiplier</span>; <span style="color: #586e75;">/*</span><span style="color: #586e75;">input scalar x </span><span style="color: #586e75;">*/</span>
   <span style="color: #b58900;">double</span> *<span style="color: #268bd2;">inArray</span>;   <span style="color: #586e75;">/* </span><span style="color: #586e75;">1xN input array </span><span style="color: #586e75;">*/</span>
   <span style="color: #b58900;">int</span>    <span style="color: #268bd2;">arraySize</span>;  <span style="color: #586e75;">/* </span><span style="color: #586e75;">size of array</span><span style="color: #586e75;">*/</span>
   <span style="color: #b58900;">double</span> *<span style="color: #268bd2;">outArray</span>;  <span style="color: #586e75;">/* </span><span style="color: #586e75;">1xN output array </span><span style="color: #586e75;">*/</span>

<span style="color: #586e75;">/* </span><span style="color: #586e75;">read input from matlab calling</span><span style="color: #586e75;">*/</span>
   multiplier = mxGetScalar<span style="color: #b58900;">(</span>prhs<span style="color: #268bd2;">[</span><span style="color: #6c71c4;">0</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span>;
   inArray    = mxGetPr<span style="color: #b58900;">(</span>prhs<span style="color: #268bd2;">[</span><span style="color: #6c71c4;">1</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span>;
   arraySize  = mxGetN<span style="color: #b58900;">(</span>prhs<span style="color: #268bd2;">[</span><span style="color: #6c71c4;">1</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span>;
<span style="color: #586e75;">/* </span><span style="color: #586e75;">create a pointer to the output array</span><span style="color: #586e75;">*/</span>
   plhs<span style="color: #b58900;">[</span><span style="color: #6c71c4;">0</span><span style="color: #b58900;">]</span>    = mxCreateDoubleMatrix<span style="color: #b58900;">(</span><span style="color: #6c71c4;">1</span>,arraySize<span style="color: #b58900;">)</span>;
   outArray   = mxGetPr<span style="color: #b58900;">(</span>plhs<span style="color: #268bd2;">[</span><span style="color: #6c71c4;">0</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span>;
<span style="color: #586e75;">/* </span><span style="color: #586e75;">call arrayProduct </span><span style="color: #586e75;">*/</span>
   arrayProduct<span style="color: #b58900;">(</span>multiplier, inArray, outArray, arraySize<span style="color: #b58900;">)</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>

<p>
至此，我们的 <code>arrayProduct</code> 就算完工了。注意： <code>mxGetPr</code> <code>mxGetN</code> <code>mxCreateDoubleMatrix</code> 这三个函数都是matlab为混合C编程提供的API，通过 #include "mex.h" 提供，可以在matlab的帮助文档中查找其详细用法。
</p>
</div>
</div>
<div id="outline-container-orgheadline5" class="outline-3">
<h3 id="orgheadline5"><span class="section-number-3">2.4</span> 创建 <code>MEX</code> 文件</h3>
<div class="outline-text-3" id="text-2-4">
<p>

</p>

<p>
创建 <code>MEX</code> 文件要使用 <code>mex</code> 命令。关于这个命令的使用可以在matlab的命令窗口里使用 <code>doc mex</code> 来查看其帮助文档。我们这里就仅仅使用 <code>mex</code> ，不对其进行详细介绍。
</p>
<div class="org-src-container">

<pre class="src src-matlab">mex arrayProduct.c <span style="color: #b58900;">-</span>o arrayProduct
</pre>
</div>
<p>
这样我们就生成了 <code>MEX</code> 文件，其名称为 <code>arrayProduct.mexw64</code> 。后缀名 <code>mexw64</code> 根据操作的不同而不同， 我的PC用的是64位windows 操作系统。 在32位windows下，后缀名为 <code>mexw32</code> 。 在64位linux下，后缀名是 <code>mexa64</code> 。
</p>

<p>
在上面的命令中即使不添加 <code>-o arrayProduct</code> 也会默认生成 <code>arrayProduct.mexw64</code> 。这里只是演示你可以使用 <code>-o</code> 选项改写生成 <code>MEX</code> 的文件名。
</p>
</div>
</div>
<div id="outline-container-orgheadline6" class="outline-3">
<h3 id="orgheadline6"><span class="section-number-3">2.5</span> 调用 <code>MEX</code> 文件</h3>
<div class="outline-text-3" id="text-2-5">
<p>

</p>

<p>
我们在前面已经演示过怎样调用 <code>arrayProduct</code> 函数。为了根治强迫症晚期患者（就是我），这里再调用一次，整个博文内容就完满喽。
</p>

<div class="org-src-container">

<pre class="src src-matlab">x = 7;
Y = [6, 1, 2];
Z = arrayProduct(x,Y)
</pre>
</div>

<p>
输出：
</p>
<div class="org-src-container">

<pre class="src src-matlab"><span style="color: #268bd2; font-weight: bold;">ans</span> =
    42,7,14
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline10" class="outline-2">
<h2 id="orgheadline10"><span class="section-number-2">3</span> Mex文件的数据流</h2>
<div class="outline-text-2" id="text-3">
<p>

</p>

<p>
通过前面的例子，我觉得有必要总结一下matlab调用mexFunction的数据流。
</p>
</div>

<div id="outline-container-orgheadline8" class="outline-3">
<h3 id="orgheadline8"><span class="section-number-3">3.1</span> 输入和输出</h3>
<div class="outline-text-3" id="text-3-1">
<p>

</p>

<p>
假设我们的MEX文件名字是 <code>func.c</code> ，该函数有两个输入和一个输出。则matlab调用该MEX文件的语法是
</p>
<div class="org-src-container">

<pre class="src src-matlab">[C,D] = func(Y,Z)
</pre>
</div>
<p>
则 <code>mexFunction</code> 的四个输入参数解释如图<a href="#orgparagraph1">1</a>所示。
</p>

<div id="orgparagraph1" class="figure">
<p><img src="../../img/20151110mexinputoutput.jpg" alt="20151110mexinputoutput.jpg" width="400" align="center" />
</p>
<p><span class="figure-number">图 1:</span> mexFunction输入输出参数</p>
</div>

<p>
由于输入参数是两个，所以 <code>mexFunction</code> 的 <code>nrhs=2</code> ; 由于输出参数是2个， 所以 <code>mexFunction</code> 的 <code>nlhs=2</code> 。输入参数通过指针数组 <code>prhs</code> 来索引： <code>prhs[0]</code> 指向 <code>Y</code> ； <code>prhs[1]</code> 指向 <code>Z</code> 。输出参数通过指针 <code>plhs</code> 来获取，调用 <code>mexFunction</code> 时，该指针为空指针，我们需要在 <code>myFunction.c</code> 里面为其申请空间，并赋予 <code>plhs[0]</code> 和 <code>plhs[1]</code> 申请的内存空间地址（这一步是很重要的，再说一遍：在我们编写 <code>myFunction.c</code> 时需要在 <code>mexFunction</code> 函数体内为 <code>plhs[0]</code> 和 <code>plhs[1]</code> 赋予一个地址，指向存放输出的内存地址）。
</p>
</div>
</div>
<div id="outline-container-orgheadline9" class="outline-3">
<h3 id="orgheadline9"><span class="section-number-3">3.2</span> <code>mexFunction</code> 的数据流动</h3>
<div class="outline-text-3" id="text-3-2">
<p>

</p>

<p>
当我们调用 <code>[C,D]=func[A,B]</code> 时， 图<a href="#orgparagraph2">2</a>给出了输入输出的转换过程。
</p>

<div id="orgparagraph2" class="figure">
<p><img src="../../img/20151110mexdataflow.jpg" alt="20151110mexdataflow.jpg" width="700" align="center" />
</p>
<p><span class="figure-number">图 2:</span> 调用[C,D]=func[A,B]对应的数据流程</p>
</div>

<p>
整个过程大致可以用以下步骤描述：
</p>
<ol class="org-ol">
<li>matlab脚本调用 <code>[C,D]=func[A,B]</code> ,把 <code>A,B</code> 作为输入传送给 MEX文件， <code>C,D</code> 未赋值。 （ 注意这一步是matlab自动为我们完成的。）</li>
<li>在 <code>mexFunction</code> 函数里， 通过 <code>A=prhs[0]</code> 和 <code>B=prhs[1]</code> 获取指向输入的地址。（ 注意这一步是需要我们自己完成的）</li>
<li>使用 <code>mxCreate</code> 函数创建用于保存输出的数组，并把这些数组的地址赋给 <code>plhs[0]</code> 和 <code>plhs[1]</code> （ 注意这一步是需要我们自己完成的）</li>
<li>在matlab脚本中， MEX文件的返回值通过 <code>plhs[0]</code> 和 <code>plhs[1]</code> 赋给 <code>C,D</code> 。（注意这一步是matlab自动为我们完成的。）</li>
</ol>

<p>
在上述步骤2和步骤3中，matlab为我们提供了很多API方便我们对输入和输出进行操作，比如<a href="#orgtarget1">创建桥梁变量</a> 一节用到的 <code>mxGetN</code> 等函数，还有这一节用到的 <code>mxCreate</code> 函数。这些API是matlab提供的。通过 <code>#include “mex.h”</code> 我们可以在自己的C文件中使用，就像使用C语言自带的函数库一样。
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline11" class="outline-2">
<h2 id="orgheadline11"><span class="section-number-2">4</span> 尾声</h2>
<div class="outline-text-2" id="text-4">
<p>

</p>

<p>
matlab调用C函数要点
</p>
<ul class="org-ul">
<li>matlab使用 <code>mexFunction</code> 封装用户定义的C函数</li>
<li>用户使用matlab调用C函数（这里是 <code>arrayProduct</code> ）就像调用matlab的内嵌函数一样。对用户来讲， <code>mexFunction</code> 是透明的，就像不存在一样。</li>
<li>matlab脚本和 <code>mexFunction</code> 之间使用 <code>nlhs</code> <code>plhs</code> <code>nrhs</code> <code>prhs</code> 来完成参数传递。 <code>mexFunction</code> 函数使用matlab提供的API实现参数传递和matlab数据类型到C数据类型的转换。</li>
<li>matlab 使用 <code>mex</code> 命令将用户编写的C文件编译成后缀名为 <code>mexw64</code> 的文件（后缀名依操作系统而定）。</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'zclspace';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>
</body>
</html>
