<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>学习Python Doc第七天: 错误和例外</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="张朝龙" />
<link rel="stylesheet" type="text/css" href="../../css/worg.css" />
<a id="home" href="../../index.html"><img src="../../img/assets/home.png" ></a>
<a id="pdf"  href="./learning-python-day07.pdf"><img src="../../img/assets/pdf.png"></a>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">学习Python Doc第七天: 错误和例外</h1>
<div id="table-of-contents">
<h2>目录</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org2f8756f">1. 语法错误</a></li>
<li><a href="#org4b1d85d">2. 例外</a></li>
<li><a href="#orgc916e9f">3. 处理例外</a></li>
<li><a href="#org4abaf8a">4. 发起一个例外</a></li>
<li><a href="#org5a08966">5. 用户定义例外</a></li>
<li><a href="#orgf9e6863">6. 定义 <code>clean-up</code> 动作</a></li>
<li><a href="#org90a27a3">7. 预先定义 <code>clean-up</code> 动作</a></li>
</ul>
</div>
</div>
<p>
截至目前，我们见过 <code>Python</code> 的报错信息，但是我们还没有涉及 <code>Python</code> 的错误和例外处理机制。在python中有两类错误： 语法错误和例外。
</p>

<div id="outline-container-org2f8756f" class="outline-2">
<h2 id="org2f8756f"><span class="section-number-2">1</span> 语法错误</h2>
<div class="outline-text-2" id="text-1">
<p>

</p>

<p>
语法错误可能是最常见的错误，也做好调试。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">while</span> <span style="color: #268bd2; font-weight: bold;">True</span> <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'hello world'</span><span style="color: #2aa198;">)</span>
</pre>
</div>

<p>
显示报错信息：
</p>
<pre class="example">
    while True print('hello world')
                   ^
SyntaxError: invalid syntax
</pre>
<p>
解释器会提示报错信息。
</p>
</div>
</div>
<div id="outline-container-org4b1d85d" class="outline-2">
<h2 id="org4b1d85d"><span class="section-number-2">2</span> 例外</h2>
<div class="outline-text-2" id="text-2">
<p>

</p>

<p>
即便一个表达式语法正确，其执行过程中仍然可能导致错误。执行过程中的错误叫做例外。
</p>

<p>
先看几个例外。
</p>
<ol class="org-ol">
<li>除零</li>
</ol>
<pre class="example">
&gt;&gt;&gt; 10*(1/0)
ZeroDivisionError: division by zero
</pre>
<ol class="org-ol">
<li>变量未定义</li>
</ol>

<pre class="example">
&gt;&gt;&gt; 4 + spam*3
NameError: name 'spam' is not defined
</pre>

<ol class="org-ol">
<li>类型不匹配</li>
</ol>

<pre class="example">
&gt;&gt;&gt; '2' + 2
TypeError: Can't convert 'int' object to str implicitly
</pre>
<p>
在以上的三个例子中，出现的例外有： <code>ZeroDivisionError</code> ,  <code>NameError</code> , <code>TypeError</code> . 这三个例外的名字是事先定义好的。Python有许多内置的例外信息可以点击<a href="https://docs.python.org/3.5/library/exceptions.html#bltin-exceptions">这里</a> 查询。
</p>
</div>
</div>

<div id="outline-container-orgc916e9f" class="outline-2">
<h2 id="orgc916e9f"><span class="section-number-2">3</span> 处理例外</h2>
<div class="outline-text-2" id="text-3">
<p>

</p>

<p>
编写程序时可以针对特定的例外执行相关操作。看代码：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">while</span> <span style="color: #268bd2; font-weight: bold;">True</span>:
    <span style="color: #859900; font-weight: bold;">try</span>:
        <span style="color: #268bd2;">x</span> = <span style="color: #839496; font-weight: bold;">int</span><span style="color: #2aa198;">(</span><span style="color: #839496; font-weight: bold;">input</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">"please enter a number:"</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
    <span style="color: #859900; font-weight: bold;">except</span> <span style="color: #b58900;">ValueError</span>:
        <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"Oops! That was no valid number. Try again"</span><span style="color: #2aa198;">)</span>
</pre>
</div>

<p>
整个程序执行顺序是：
</p>
<ol class="org-ol">
<li>在 <code>try</code> 和 <code>except</code> 之间的语句首先执行。</li>
<li>如果没有例外发生， <code>except</code> 之后的语句就会被跳过。</li>
<li>如果例外发生，并且类型和 <code>except</code> 之后的类型一样(本例中是 <code>ValueError</code> )。 <code>except</code> 后面的语句被执行。</li>
<li>如果例外发生，但是类型和 <code>except</code> 后面的类型不同，那么这个例外就是未处理例外，程序停止执行。</li>
</ol>

<p>
一个 <code>try</code> 可以有多个例外语句。一个 <code>except</code> 语句可以包含多个例外关键词。看代码：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">import</span> sys

<span style="color: #859900; font-weight: bold;">try</span>:
    <span style="color: #268bd2;">f</span> = <span style="color: #839496; font-weight: bold;">open</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'myfile.txt'</span><span style="color: #2aa198;">)</span>
    <span style="color: #268bd2;">s</span> = f.readline<span style="color: #2aa198;">()</span>
    <span style="color: #268bd2;">i</span> = <span style="color: #839496; font-weight: bold;">int</span><span style="color: #2aa198;">(</span>s.strip<span style="color: #b58900;">()</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">except</span> <span style="color: #b58900;">OSError</span> <span style="color: #859900; font-weight: bold;">as</span> err:
    <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"OS error: {0}"</span>.<span style="color: #839496; font-weight: bold;">format</span><span style="color: #b58900;">(</span>err<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">except</span> <span style="color: #b58900;">ValueError</span>:
    <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"Could not convert data to an integer."</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">except</span>:
    <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"Unexpected error:"</span>, sys.exc_info<span style="color: #b58900;">()[</span><span style="color: #6c71c4;">0</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
    <span style="color: #859900; font-weight: bold;">raise</span>
</pre>
</div>

<p>
另外 <code>try except</code> 语句可以有 <code>else</code> ，看代码：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">for</span> arg <span style="color: #859900; font-weight: bold;">in</span> sys.argv<span style="color: #2aa198;">[</span><span style="color: #6c71c4;">1</span>:<span style="color: #2aa198;">]</span>:
    <span style="color: #859900; font-weight: bold;">try</span>:
        <span style="color: #268bd2;">f</span> = <span style="color: #839496; font-weight: bold;">open</span><span style="color: #2aa198;">(</span>arg, <span style="color: #2aa198;">'r'</span><span style="color: #2aa198;">)</span>
    <span style="color: #859900; font-weight: bold;">except</span> <span style="color: #b58900;">IOError</span>:
        <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'cannot open'</span>, arg<span style="color: #2aa198;">)</span>
    <span style="color: #859900; font-weight: bold;">else</span>:
        <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>arg, <span style="color: #2aa198;">'has'</span>, <span style="color: #839496; font-weight: bold;">len</span><span style="color: #b58900;">(</span>f.readlines<span style="color: #268bd2;">()</span><span style="color: #b58900;">)</span>, <span style="color: #2aa198;">'lines'</span><span style="color: #2aa198;">)</span>
        f.close<span style="color: #2aa198;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4abaf8a" class="outline-2">
<h2 id="org4abaf8a"><span class="section-number-2">4</span> 发起一个例外</h2>
<div class="outline-text-2" id="text-4">
<p>

</p>

<p>
<code>raise</code> 语句强制程序发起例外。看代码：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">raise</span> <span style="color: #b58900;">NameError</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'HiThere'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5a08966" class="outline-2">
<h2 id="org5a08966"><span class="section-number-2">5</span> 用户定义例外</h2>
<div class="outline-text-2" id="text-5">
<p>

</p>

<p>
通过创建一个新的例外类（一切都是对象，所有的例外类都应当从 <code>Exception</code> 继承而来。） 程序可以命名自己的例外。
</p>

<p>
可以定义例外类，这个例外类可以做其他类能做的一切。通过创建一个基类，可以创建一个可以处理多个不同错误的模块。每个基于这个基类的子类负责处理特定的例外。看代码：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Error</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">Exception</span><span style="color: #2aa198;">)</span>:
    <span style="color: #2aa198;">"""Base class for exceptions in this module."""</span>
    <span style="color: #859900; font-weight: bold;">pass</span>

<span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">InputError</span><span style="color: #2aa198;">(</span>Error<span style="color: #2aa198;">)</span>:
    <span style="color: #2aa198;">"""Exception raised for errors in the input.</span>

<span style="color: #2aa198;">    Attributes:</span>
<span style="color: #2aa198;">        expression -- input expression in which the error occurred</span>
<span style="color: #2aa198;">        message -- explanation of the error</span>
<span style="color: #2aa198;">    """</span>

    <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__init__</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, expression, message<span style="color: #2aa198;">)</span>:
        <span style="color: #859900; font-weight: bold;">self</span>.expression = expression
        <span style="color: #859900; font-weight: bold;">self</span>.message = message

<span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">TransitionError</span><span style="color: #2aa198;">(</span>Error<span style="color: #2aa198;">)</span>:
    <span style="color: #2aa198;">"""Raised when an operation attempts a state transition that's not</span>
<span style="color: #2aa198;">    allowed.</span>

<span style="color: #2aa198;">    Attributes:</span>
<span style="color: #2aa198;">        previous -- state at beginning of transition</span>
<span style="color: #2aa198;">        next -- attempted new state</span>
<span style="color: #2aa198;">        message -- explanation of why the specific transition is not allowed</span>
<span style="color: #2aa198;">    """</span>

    <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__init__</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, previous, <span style="color: #839496; font-weight: bold;">next</span>, message<span style="color: #2aa198;">)</span>:
        <span style="color: #859900; font-weight: bold;">self</span>.previous = previous
        <span style="color: #859900; font-weight: bold;">self</span>.<span style="color: #839496; font-weight: bold;">next</span> = <span style="color: #839496; font-weight: bold;">next</span>
        <span style="color: #859900; font-weight: bold;">self</span>.message = message
</pre>
</div>

<p>
每个例外都是基于 <code>Error</code> 这个类来的。
</p>
</div>
</div>

<div id="outline-container-orgf9e6863" class="outline-2">
<h2 id="orgf9e6863"><span class="section-number-2">6</span> 定义 <code>clean-up</code> 动作</h2>
<div class="outline-text-2" id="text-6">
<p>

</p>

<p>
<code>try</code> 语句有另外一个可选的语句 <code>finally</code> ，专门用来定义清理动作。清理动作在所有情况之后执行。看代码：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">try</span>:
    <span style="color: #859900; font-weight: bold;">raise</span> <span style="color: #b58900;">KeyboardInterrupt</span>
<span style="color: #859900; font-weight: bold;">finally</span>:
    <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'Goodbye, world'</span><span style="color: #2aa198;">)</span>
</pre>
</div>

<p>
<code>finally</code> 语句在离开 <code>try</code> 语句之后必须不管是否有例外发生都执行。看代码：
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">divide</span><span style="color: #2aa198;">(</span>x,y<span style="color: #2aa198;">)</span>:
<span class="linenr">2: </span>    <span style="color: #859900; font-weight: bold;">try</span>:
<span class="linenr">3: </span>        <span style="color: #268bd2;">result</span> = x/y
<span class="linenr">4: </span>    <span style="color: #859900; font-weight: bold;">except</span> <span style="color: #b58900;">ZeroDivisionError</span>:
<span class="linenr">5: </span>        <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"division by zero"</span><span style="color: #2aa198;">)</span>
<span class="linenr">6: </span>    <span style="color: #859900; font-weight: bold;">else</span>:
<span class="linenr">7: </span>        <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"result is "</span>,result<span style="color: #2aa198;">)</span>
<span class="linenr">8: </span>    <span style="color: #859900; font-weight: bold;">finally</span>:
<span class="linenr">9: </span>        <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"executing finally clause"</span><span style="color: #2aa198;">)</span>
</pre>
</div>
<p>
输出是：
</p>

<pre class="example">
In [3]: divide(2,1)
result is  2.0
executing finally clause

In [11]: divide(2,0)
division by zero
executing finally clause
</pre>

<p>
我们可以看到无论如何 <code>finally</code> 的语句都会执行。
</p>
</div>
</div>

<div id="outline-container-org90a27a3" class="outline-2">
<h2 id="org90a27a3"><span class="section-number-2">7</span> 预先定义 <code>clean-up</code> 动作</h2>
<div class="outline-text-2" id="text-7">
<p>

</p>

<p>
有些类定义了标准的 <code>clean-up</code> 动作。下面的代码打开一个文件，打印其内容到屏幕：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">for</span> line <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #839496; font-weight: bold;">open</span> <span style="color: #2aa198;">(</span><span style="color: #2aa198;">"myfile.txt"</span><span style="color: #2aa198;">)</span>:
    <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>line,end=<span style="color: #2aa198;">""</span><span style="color: #2aa198;">)</span>
</pre>
</div>

<p>
这段代码的问题是：代码执行结束之后，文件会保持打开状态一段时间。对于简单的脚本而言不是什么问题，但是对于较大的应用，这个可能会导致问题。  <code>with</code> 语句允许像 <code>file</code> 这样的对象一直处于clean up状态。
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #859900; font-weight: bold;">with</span> <span style="color: #839496; font-weight: bold;">open</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"myfile.txt"</span><span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">as</span> f:
<span class="linenr">2: </span>    <span style="color: #859900; font-weight: bold;">for</span> line <span style="color: #859900; font-weight: bold;">in</span> f:
<span class="linenr">3: </span>        <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>line, end=<span style="color: #2aa198;">""</span><span style="color: #2aa198;">)</span>
</pre>
</div>

<p>
代码执行之后，文件 <code>f</code> 总是关闭的（即使在处理文件过程中发生问题。）。
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'zclspace';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>
</body>
</html>
